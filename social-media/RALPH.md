# Ralph Scripts (SocialHub)

This repo includes a small set of scripts that run an agentic implementation loop against `docs/PLAN`.

The core idea:
- **`docs/PLAN` is the source of truth**.
- Each agent iteration is expected to complete **exactly one** `prd.json` item (`passes: false` -> `true`).
- The agent must perform **bookkeeping** (update milestone `Progress.md`, and mark the PRD item `passes=true`).

## Prerequisites

- `qwen` CLI installed and available on PATH.
- Node/npm installed (validator runs `npm run build`).
- (Optional) `uuidgen` (used to generate new session ids; script falls back to Python or random).

## Files Produced / Updated

- `progress.md`
  - Appends a short log entry per iteration (tail of the Qwen output).
- `.validator-report.md`
  - Written by the validator with build status + validator agent findings.
- `docs/PLAN/Phase-0-Critic-Backlog/Milestone-0.1-Unmock-Codebase/`
  - Generated by the critic scan. Contains a PRD backlog of mocked/stubbed implementations to implement.

---

# 1) `./ralph.sh`

Runs the main implementation loop.

## What it does

For each iteration:
- Picks a session id:
  - **New per iteration** (default), or
  - **Persistent** if you provide a session id.
- Prompts Qwen to follow `/execute` and:
  - Find the next milestone with pending work
  - Pick the next PRD item top-to-bottom where `passes=false`
  - Implement it end-to-end
  - Do bookkeeping
- Appends a concise summary to `progress.md`.
- Optionally runs the validator every N iterations.

## Usage

```bash
./ralph.sh <iterations> [session-id] [--validate-every N] [--critic|--critic-only]
```

## Arguments / Flags

- `<iterations>`
  - Required. Number of agent iterations.

- `[session-id]`
  - Optional. If provided (must not start with `--`), all iterations use the same Qwen session.
  - If omitted, `ralph.sh` generates a new UUID session id per iteration.

- `--validate-every N`
  - Optional. Run `ralph-validator.sh` every N iterations.
  - Use `--validate-every 0` to disable validation.

- `--critic`
  - Optional. Run `ralph-critic.sh` first (generates a PLAN backlog for mocked/stubbed code), then run iterations.

- `--critic-only`
  - Optional. Run `ralph-critic.sh` and exit (no iterations).

## Examples

New session each iteration:
```bash
./ralph.sh 5
```

Persistent session across all iterations:
```bash
./ralph.sh 5 11111111-2222-3333-4444-555555555555
```

Critic scan + run iterations:
```bash
./ralph.sh 5 --critic
```

Critic scan only:
```bash
./ralph.sh 1 --critic-only
```

Validation every 2 iterations (default):
```bash
./ralph.sh 10 --validate-every 2
```

---

# 2) `./ralph-validator.sh`

Spawns a validator agent to audit correctness + bookkeeping.

## What it does

- Runs a local build check (`npm run build`).
- Checks whether Playwright tooling is available.
- Spawns a Qwen agent with `/audit-execute` prompt to:
  - Identify the most recently worked milestone
  - Verify bookkeeping (`Progress.md`, `prd.json` updates)
  - Verify the implementation is not stubbed
  - Report blockers and actionable fixes
- Writes `.validator-report.md`.

## Usage

```bash
./ralph-validator.sh <iteration>
./ralph-validator.sh <session-id> <iteration>
```

## Examples

Isolated validator run (fresh session):
```bash
./ralph-validator.sh 3
```

Validator referencing the same session as the main loop:
```bash
./ralph-validator.sh 11111111-2222-3333-4444-555555555555 3
```

---

# 3) `./ralph-critic.sh`

Static code scan to find mocked / stubbed implementations and push them into `docs/PLAN` as implementable PRD items.

## What it does

- Walks the repo and searches for indicators like:
  - `TODO`, `FIXME`, `XXX`
  - `mock`, `stub`, `placeholder`
  - `not implemented`, `in real implementation`
  - (TS/JS heuristics) `throw new Error("not implemented")`, suspicious empty returns
- Excludes generated/vendor paths (e.g. `node_modules`, `dist`, `.angular`, `.ralph`, `coverage`) and excludes `docs/PLAN` to avoid self-referential findings.
- Writes a milestone under:
  - `docs/PLAN/Phase-0-Critic-Backlog/Milestone-0.1-Unmock-Codebase/`

### How PRD items are organized

To keep the backlog manageable:
- Findings are **grouped by file**.
- Each PRD item typically means: **"remove stubs/mocks/TODOs in this file"**.

## Usage

```bash
./ralph-critic.sh [session-id] [--plan-root PATH] [--max-items N]
```

- `session-id` is accepted for symmetry with the other scripts, but the scan is static and does not require it.

## Examples

Default scan (writes to `docs/PLAN`):
```bash
./ralph-critic.sh
```

Scan but cap the PRD size:
```bash
./ralph-critic.sh --max-items 100
```

Write backlog to a different PLAN root:
```bash
./ralph-critic.sh --plan-root /abs/path/to/docs/PLAN
```

---

# Typical Workflows

## A) Normal implementation loop

```bash
./ralph.sh 5
```

## B) Critic-driven cleanup (unmock the codebase)

1) Generate backlog:
```bash
./ralph-critic.sh
```

2) Run iterations to burn down the backlog (one PRD item per iteration):
```bash
./ralph.sh 10
```

(Or do it in one go):
```bash
./ralph.sh 10 --critic
```

## C) Add validation

```bash
./ralph.sh 10 --validate-every 2
```

---

# Troubleshooting

## Qwen session id errors
- If you want persistent context, pass a UUID session id.
- If you do not pass a session id, `ralph.sh` generates a UUID per iteration.

## Validator failures
- If `.validator-report.md` says `BLOCKERS: yes` or build failed:
  - Fix blockers in the milestone before continuing.

## Critic generates too many items
- Lower the cap:
  - `./ralph-critic.sh --max-items 50`

## PLAN bookkeeping expectations
A PRD item should only be marked `passes: true` when:
- Acceptance criteria are met
- No placeholders/stubs remain for that item
- `Progress.md` reflects the change
